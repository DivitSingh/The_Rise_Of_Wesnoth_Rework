#textdomain wesnoth-trow
[scenario]
    id=04_Temple_in_the_Deep
    name= _ "Temple in the Deep"
    next_scenario=
    victory_when_enemies_defeated=no
    map_file=04_Temple_in_the_Deep.map
    turns=30
    {UNDERGROUND}

    {SCENARIO_MUSIC knalgan_theme.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}

    [story]
        [part]
            story= _ "Prince Haldric and his company, grim and watchful, descend into catacombs below the temple, buried deep in the bedrock, in the very roots of the world itself. In the distance Haldric hears a booming voice."
            background=story/trow_story_06-Temple_in_the_Deep.webp
        [/part]
    [/story]

    {TROW_GI_TRACK {JOURNEY_04_NEW} }

    {TROW_DEATHS}

    [side]
        side=1
        type=Noble Commander
        id=Prince Haldric
        name= _ "Prince Haldric"
        unrenamable=yes
        canrecruit=yes
        {GOLD 160 140 120}
        controller=human
        shroud=yes
        team_name=Haldric
        user_team_name=_"Refugees"
        {FLAG_VARIANT loyalist}

        [unit]
            type=Shadow Lord
            id=Eravan
            name= _ "Eravan"
            x,y=13,24
            [modifications]
                {TRAIT_LOYAL} {TRAIT_HEALTHY}
            [/modifications]
            {IS_LOYAL}
        [/unit]
        [unit]
            type=Rogue Mage
            x,y=12,24
            [modifications]
                {TRAIT_QUICK} {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        [unit]
            type=Rogue Mage
            x,y=14,24
            [modifications]
                {TRAIT_STRONG} {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]
    [/side]

    [side]
        side=2
        type=Lich
        id=Lich-Lord Lenvan
        name= _ "Lich-Lord Lenvan"
        canrecruit=yes
        recruit=Skeleton,Skeleton Archer,Ghoul
        placement=leader
        hitpoints=35
        [status]
            unhealable=yes
        [/status]
        [modifications]
            {TRAIT_WEAK}
        [/modifications]
        {GOLD 200 250 300}
        {INCOME 5 10 15}
        team_name=undead
        user_team_name=_"Undead"
        [ai]
            passive_leader=yes
            aggression=1.0
        [/ai]
        [unit]
            type=Spectre
            id=Haralin
            name= _ "Haralin"
            x,y=3,23
            ai_special=guardian
            {IS_HERO}
        [/unit]
        [unit]
            type=Giant Ant Queen
            x,y=22,12
            ai_special=guardian
            {IS_HERO}
        [/unit]
        {FLAG_VARIANT undead}
    [/side]

#define SKELETON_TRAP X Y UNIT_TYPE
        [unit]
            type={UNIT_TYPE}
            side=2
            x,y={X},{Y}
            max_moves=0
            [abilities]
                [hides]
                [/hides]
            [/abilities]
        [/unit]
#enddef

    {FORCE_CHANCE_TO_HIT (
        side=1,2
        [not]
            type=Rogue Mage,Shadow Mage,Shadow Lord
        [/not]
    )(id=Lich-Lord Lenvan) 0 (
    )}

    [event]
        name=prestart

#ifdef EASY
        {LOYAL_UNIT 2 (Tentacle of the Deep) 3 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 22 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 10 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 16 16}
#endif
#ifdef NORMAL
        {LOYAL_UNIT 2 (Tentacle of the Deep) 3 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 22 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 10 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 16 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 12 17}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 14 17}
#endif
#ifdef HARD
        {LOYAL_UNIT 2 (Tentacle of the Deep) 3 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 22 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 10 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 16 16}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 12 17}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 14 17}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 10 15}
        {LOYAL_UNIT 2 (Tentacle of the Deep) 16 15}
#endif

        {GENERIC_UNIT 2 (Giant Ant) 20 12} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 21 12} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 21 13} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 22 11} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 22 13} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 23 13} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 23 12} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 24 12} {GUARDIAN}

        {SKELETON_TRAP 11 7 Skeleton}
        {SKELETON_TRAP 12 7 Skeleton}
        {SKELETON_TRAP 13 7 Deathblade}
        {SKELETON_TRAP 14 7 Skeleton}
        {SKELETON_TRAP 15 7 Skeleton}

        {PLACE_IMAGE (items/chest.png) 13 1}
        {PLACE_IMAGE (items/chest-plain-closed.png) 2 6}
        {PLACE_IMAGE "items/daeola_statue.png~GS()~FL(horiz)" 14 1}
        {PLACE_IMAGE "items/daeola_statue.png~GS()" 12 1}

        {OBJ_POTION_HOLY_ALT 13 19 (holy_helper)}

        [set_variable]
            name=door_locked
            value=0
        [/set_variable]

        [recall]
            id=Burin the Lost
        [/recall]
        [recall]
            id=Minister Edren
        [/recall]

        [objectives]
            side=1
            [objective]
                description= _ "Defeat the Lich-Lord"
                condition=win
            [/objective]
            [objective]
                description= _ "Retrieve the Fire Ruby (with Prince Haldric)"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Prince Haldric"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description= _ "Lich-Lord Lenvan can only be damaged by Rogue Magi, Shadow Magi, and Shadow Lords."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=start

        [message]
            speaker=Lich-Lord Lenvan
            message= _ "Free! I’m free at last! No mere magi could seal me in here forever! Rise, my soldiers of darkness, the world will be ours once more!"
        [/message]
        [message]
            speaker=Burin the Lost
            message= _ "Back underground... Och. this feels much better! As for the current residents, ugh!"
        [/message]
        [message]
            speaker=Prince Haldric
            message= _ "Let’s send these monsters to their final rest."
            image=portraits/haldric-mad.webp
        [/message]
        [message]
            speaker=Eravan
            message= _ "That would be easier said than done. Lord Lenvan was among the most talented and intelligent of our leaders. It is a shame to see him in this pitiable state, but I am certain he has prepared this lair to be as dangerous as possible."
        [/message]
        [message]
            type=Rogue Mage
            message= _ "There's more. Lenvan created a spell which made him impervious to most attacks. Only we can damage the lich as he never considered the possibility of shadow magic being used against him."
        [/message]
        [message]
            speaker=Prince Haldric
            message= _ "That's going to be problematic. Make sure to keep our new allies out of harm's way or we may be unable to defeat the enemy."
            image=portraits/haldric-surprised.webp
        [/message]
        [message]
            speaker=Minister Edren
            message= _ "Let us rid the temple of this foul magic quickly, or the lich may regain his true power and become an unstoppable menace."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            type=Tentacle of the Deep
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "I don’t like the look of that pool at all."
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            side=1
        [/filter]
        [filter_second]
            id=Lich-Lord Lenvan
        [/filter_second]
        [message]
            speaker=Lich-Lord Lenvan
            message= _ "The mortals near my castle. Rise, spirits of the dead, and vanquish these fools!"
        [/message]
        [sound]
            name=magic-dark.ogg
        [/sound]
        {GENERIC_UNIT 2 (Ghost) 22 2}
        {GENERIC_UNIT 2 (Ghost) 21 2}
        {GENERIC_UNIT 2 (Ghost) 23 3}
        {GENERIC_UNIT 2 (Ghost) 21 1}
        {GENERIC_UNIT 2 (Ghost) 22 1}
#ifdef NORMAL
        {GENERIC_UNIT 2 (Shadow) 23 2}
#endif
#ifdef HARD
        {GENERIC_UNIT 2 (Nightgaunt) 23 2}
#endif
    [/event]

    [event]
        name=moveto
        [filter]
            x=10,10,11,11,12,12,13,13,14,14,15,15,16,16
            y=6,7,6,8,6,8,6,8,6,8,6,8,6,7
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "Oh no! There are undead in the walls!"
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=4,5
            y=18,19
        [/filter]
        [if]
            [variable]
                name=door_locked
                numerical_equals=0
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "This door is lock. I wonder what is behind it."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x=4,5
            y=18,19
        [/filter]
        [if]
            [variable]
                name=door_locked
                numerical_equals=1
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message= _ "Let me see if I can open this door here..."
                [/message]
                [sound]
                    name=unlock.ogg
                [/sound]
                [terrain]
                    x,y=4,19
                    terrain=Rr^Pr\o
                [/terrain]
                [message]
                    speaker=Haralin
                    message= _ "Woe upon you, wretched ones bearing weapons of the Isle and serving the Kings. The Ruby will not leave this temple!"
                [/message]
                [message]
                    speaker=Prince Haldric
                    message= _ "Hmm... This ghost might have something to do with the Ruby. Perhaps Lenvan is not the only one guarding it."
                [/message]
                [set_variable]
                    name=door_locked
                    value=0
                [/set_variable]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=18,19
            y=14,15
        [/filter]
        [message]
            speaker=unit
            message= _ "Let me see if I can open this door here..."
        [/message]
        [sound]
            name=unlock.ogg
        [/sound]
        [terrain]
            x,y=19,14
            terrain=Rr^Pr\o
        [/terrain]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=13,1
        [/filter]
        [message]
            speaker=unit
            message= _ "This chest is empty."
        [/message]
        [if]
            [variable]
                name=Have_Ruby
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=Prince Haldric
                    message= _ "Ugh where's the real one!"
                    image=portraits/haldric-surprised.webp
                [/message]
                [message]
                    speaker=Burin the Lost
                    message= _ "Hmph! That bag of bones had a trick up his sleeve."
                [/message]
            [/then]
        [/if]
        {REMOVE_IMAGE 13 1}
        {PLACE_IMAGE (items/chest-open.png) 13 1}
    [/event]

    [event]
        name=attack end
        [filter]
            side=1
            [not]
                type=Rogue Mage,Shadow Mage,Shadow Lord
            [/not]
        [/filter]

        [filter_second]
            id=Lich-Lord Lenvan
        [/filter_second]
        [message]
            speaker=Lich-Lord Lenvan
            message= _ "Hah! Your miserable attacks will have no effect."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Haralin
        [/filter]
        [message]
            speaker=unit
            message= _ "Curses, I — Haralin the First — was not able to protect <i>my</i> Ruby."
        [/message]
        [message]
            speaker=Minister Edren
            message= _ "Haralin, I've heard that name before. He was among the foremost mages of the Isle before succumbing to the Darkness. It is well that his soul shall now rest in peace."
        [/message]
        [sound]
            name=rumble.ogg
        [/sound]
        [terrain]
            x=4,5,6,7
            y=10,11,11,12
            terrain=Urb
        [/terrain]
    [/event]

    [event]
        name=last breath
        [filter]
            type=Giant Ant Queen
        [/filter]
        [message]
            speaker=second_unit
            message= _ "That was one big ant. Looks like it was guarding some gold and a key as well!"
        [/message]
        [sound]
            name=gold.ogg
        [/sound]
        [gold]
            amount={ON_DIFFICULTY 75 50 50}
            side=1
        [/gold]
        [set_variable]
            name=door_locked
            value=1
        [/set_variable]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lich-Lord Lenvan
        [/filter]
        [message]
            speaker=unit
            message= _ "All my days are ended. For my own people to betray me..."
        [/message]
        [message]
            speaker=Eravan
            message= _ "You are no longer the leader we once knew. It is better for you to rest in peace, Lord Lenvan."
        [/message]
        [message]
            speaker=Prince Haldric
            message= _ "The world won’t miss him one bit."
        [/message]
        [if]
            [variable]
                name=Have_Ruby
                boolean_equals=yes
            [/variable]
            [then]
                [endlevel]
                    result=victory
                    bonus=yes
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/then]
        [/if]
    [/event]

        [event]
        name=die
        [filter]
            side=1
            [not]
                id=Prince Haldric
            [/not]
        [/filter]

        [if]
            [have_unit]
                id=Lich-Lord Lenvan
            [/have_unit]
            [then]
                [message]
                    speaker=Prince Haldric
                    message= _ "He’s raising our dead!"
                    image=portraits/haldric-surprised.webp
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            [not]
                #Basically not any type that has plague
                type=Walking Corpse,Soulless
            [/not]
        [/filter_second]

        [if]
            [have_unit]
                id=Lich-Lord Lenvan
            [/have_unit]
            [then]
                {RISE_UP_RISE_UP}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=2,6
        [/filter]
        [if]
            [variable]
                name=Have_Ruby
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message= _ "Haldric already has the Ruby of Fire."
                    image=wesnoth-icon.png
                [/message]
                [allow_undo]
                [/allow_undo]
            [/then]
            [else]
                [if]
                    [have_unit]
                        id=Prince Haldric
                        x,y=2,6
                    [/have_unit]
                    [then]
                        {VARIABLE Have_Ruby yes}
                        [sound]
                            name=open-chest.wav
                        [/sound]
                        [message]
                            speaker=narrator
                            message= _ "As Haldric opens the chest, he sees it — the Ruby of Fire. It is the size of an apple and burns with an internal fire, which is refracted through its faces. He can feel the power flowing from it..."
                            image=wesnoth-icon.png
                        [/message]
                        [message]
                            speaker=Prince Haldric
                            message= _ "It’s funny that the lich-lord didn’t have this on his person. Since I don’t actually know what this thing does, I’ll just put it in the bottom of my pack for right now."
                        [/message]
                        {REMOVE_IMAGE 2 6}
                        {PLACE_IMAGE (items/chest-plain-open.png) 2 6}
                        [if]
                            [not]
                                [have_unit]
                                    id=Lich-Lord Lenvan
                                [/have_unit]
                            [/not]
                            [then]
                                [endlevel]
                                    result=victory
                                    bonus=yes
                                    {NEW_GOLD_CARRYOVER 40}
                                [/endlevel]
                            [/then]
                        [/if]
                    [/then]
                    [else]
                        [animate_unit]
                            [filter]
                                id=$unit.id
                            [/filter]
                            flag=defend
                            hits=yes
                            [primary_attack]
                                range=melee
                            [/primary_attack]
                            [secondary_attack]
                                name=$unit.attack[0].name
                            [/secondary_attack]
                            [facing]
                                x,y=13,0
                            [/facing]
                        [/animate_unit]
                        [message]
                            speaker=narrator
                            message= _ "Maybe you should move somebody else to the chest."
                            image=wesnoth-icon.png
                        [/message]
                        [allow_undo]
                        [/allow_undo]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Prince Haldric
            message= _ "I’m glad that’s over! We have the Ruby of Fire, and that Lich-Lord is now a pile of dust. Let’s get out of these catacombs!"
        [/message]
        {CLEAR_VARIABLE Have_Ruby}
    [/event]

    [event]
        name=time over
        [message]
            speaker=Prince Haldric
            message= _ "What’s that! No! The tree-folk are sealing us back in here. They must think that we’ve failed. We’re trapped."
            image=portraits/haldric-surprised.webp
        [/message]
    [/event]
[/scenario]
